Replace unsafe legacy APIs
Add type hints and dataclasses
Use repository/service pattern